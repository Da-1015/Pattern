<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å¤šå½±ç‰‡é€å¹€æ¨™è¨»å·¥å…·ï¼ˆæ–¹å‘éµä¿®æ­£ç‰ˆï¼‰</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
body { font-family: sans-serif; text-align: center; background: #fafafa; }
#videoContainer {
  position: relative;
  display: inline-block;
  overflow: hidden;
  border: 1px solid #aaa;
  width: 80%;
  max-width: 800px;
  cursor: grab;
  margin-top: 10px;
}
#video {
  width: 100%;
  transform-origin: center center;
  transition: transform 0.05s ease-out;
}
#controls { margin-top: 10px; }
.checkbox-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 4px;
  justify-content: center;
  width: 50%;
  margin: 10px auto;
}
label {
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid #ccc;
  padding: 4px;
  border-radius: 4px;
  background: white;
}
button { margin: 5px; padding: 6px 12px; cursor: pointer; border-radius: 6px; }
select { padding: 4px; margin: 8px; }
</style>
</head>
<body>

<h1>å¤šå½±ç‰‡é€å¹€æ¨™è¨»å·¥å…·</h1>

<input type="file" id="videoInput" accept="video/*" multiple><br>

<select id="videoSelector"></select><br>

<div id="videoContainer">
  <video id="video" preload="metadata"></video>
</div>

<div id="controls">
  <button id="playPause">â–¶ æ’­æ”¾</button>
  <button id="prev">â† ä¸Šä¸€å¹€</button>
  <button id="next">ä¸‹ä¸€å¹€ â†’</button>
  <span>æ™‚é–“ï¼š<span id="timeDisplay">0</span>s</span>
</div>

<h3>è«‹å‹¾é¸ç¬¦åˆæ¢ä»¶çš„é …ç›®ï¼š</h3>
<div class="checkbox-grid" id="checkboxes"></div>

<div>
  <button id="resetBtn">ğŸ§¹ é‡è£½å‹¾é¸</button>
  <button id="restoreBtn">â™»ï¸ å¾©åŸä¸Šä¸€éƒ¨</button>
  <button id="exportBtn">ğŸ’¾ åŒ¯å‡ºå…¨éƒ¨ Excel</button>
</div>

<script>
const video = document.getElementById('video');
const container = document.getElementById('videoContainer');
const videoInput = document.getElementById('videoInput');
const selector = document.getElementById('videoSelector');
const checkboxesDiv = document.getElementById('checkboxes');
const timeDisplay = document.getElementById('timeDisplay');
const playPauseBtn = document.getElementById('playPause');
const fps = 1;

let videoList = [];
let currentVideoIndex = 0;
let framesData = {};
let currentFrame = 0;
let isPlaying = false;
let playInterval = null;

// Zoom
let scale = 1, posX = 0, posY = 0;
let dragging = false, startX, startY;

// å»ºç«‹ 8 å€‹å‹¾é¸æ¡†
const itemNames = [
  "Anterior and Posterior transverse mantle line",
  "Anterior head bar",
  "Eye ring",
  "Interocular black small streak",
  "Interocular Black Stripe",
  "Mantle edge radial stripes",
  "Paired mantle spots",
  "Spark-like black dots"
];

for (let i = 0; i < itemNames.length; i++) {
  const label = document.createElement('label');
  const cb = document.createElement('input');
  cb.type = 'checkbox';
  cb.id = `item${i + 1}`;
  cb.addEventListener('change', updateLabels);
  label.appendChild(cb);
  label.appendChild(document.createTextNode(itemNames[i]));
  checkboxesDiv.appendChild(label);
}


// ä¸Šå‚³å½±ç‰‡
videoInput.addEventListener('change', e => {
  const files = Array.from(e.target.files);
  videoList = files.map(f => ({
    name: f.name,
    url: URL.createObjectURL(f),
    duration: 0
  }));

  selector.innerHTML = '';
  videoList.forEach((v, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = v.name;
    selector.appendChild(opt);
  });

  currentVideoIndex = 0;
  loadVideo(0);
});

// è¼‰å…¥å½±ç‰‡
function loadVideo(index) {
  currentVideoIndex = index;
  const v = videoList[index];
  video.src = v.url;
  video.load();

  video.onloadedmetadata = () => {
    v.duration = video.duration;
    const totalFrames = Math.floor(v.duration * fps);
    if (!framesData[v.name]) {
      framesData[v.name] = Array.from({length: totalFrames}, (_, i) => ({
        frameIndex: i,
        timeSec: i + 1,
        labels: Object.fromEntries(Array.from({length: 10}, (_, j) => [j+1, false]))
      }));
    }
    currentFrame = 0;
    video.currentTime = 0;
    showFrame(0);
  };
}

// åˆ‡æ›å½±ç‰‡
selector.addEventListener('change', e => loadVideo(parseInt(e.target.value)));

// æ’­æ”¾æ§åˆ¶
playPauseBtn.onclick = () => {
  if (isPlaying) stopPlay(); else startPlay();
};
function startPlay() {
  isPlaying = true;
  playPauseBtn.textContent = "â¸ æš«åœ";
  playInterval = setInterval(nextFrame, 1000 / fps);
}
function stopPlay() {
  isPlaying = false;
  playPauseBtn.textContent = "â–¶ æ’­æ”¾";
  clearInterval(playInterval);
}

// å¹€æ§åˆ¶
document.getElementById('prev').onclick = prevFrame;
document.getElementById('next').onclick = nextFrame;
function prevFrame() {
  if (currentFrame > 0) showFrame(currentFrame - 1);
}
function nextFrame() {
  const f = framesData[getCurrentVideoName()];
  if (currentFrame < f.length - 1) showFrame(currentFrame + 1);
}

// æ–¹å‘éµæ§åˆ¶ï¼ˆåƒ…æ§åˆ¶å¹€æ•¸ï¼Œä¸åˆ‡æ›å½±ç‰‡ï¼‰
document.addEventListener('keydown', e => {
  if (e.key === 'ArrowLeft') { e.preventDefault(); prevFrame(); }
  if (e.key === 'ArrowRight') { e.preventDefault(); nextFrame(); }
  if (e.key === ' ') { e.preventDefault(); playPauseBtn.click(); }
});

// é¡¯ç¤ºå¹€
function showFrame(index) {
  const videoName = getCurrentVideoName();
  const f = framesData[videoName];
  if (!f) return;
  currentFrame = index;
  video.currentTime = index / fps;
  timeDisplay.textContent = f[index].timeSec;
  for (let i = 1; i <= 10; i++) {
    document.getElementById(`item${i}`).checked = f[index].labels[i];
  }
}

// æ›´æ–°å‹¾é¸
function updateLabels() {
  const f = framesData[getCurrentVideoName()][currentFrame];
  for (let i = 1; i <= 10; i++) {
    f.labels[i] = document.getElementById(`item${i}`).checked;
  }
  saveState();
}

// åŒ¯å‡ºæ‰€æœ‰å½±ç‰‡
document.getElementById('exportBtn').onclick = () => {
  const wb = XLSX.utils.book_new();

  for (const [videoName, frames] of Object.entries(framesData)) {
    const header = [" "].concat(frames.map(f => `${f.timeSec}(ç§’)`));
    const rows = [header];
    for (let i = 1; i <= 10; i++) {
      const row = [`é …ç›®${i}`];
      frames.forEach(f => row.push(f.labels[i] ? 1 : 0));
      rows.push(row);
    }
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, videoName.slice(0, 20));
  }

  XLSX.writeFile(wb, "å¤šå½±ç‰‡æ¨™è¨»çµæœ.xlsx");
};

// é‡è£½
document.getElementById('resetBtn').onclick = () => {
  if (!confirm("ç¢ºå®šè¦æ¸…é™¤ç•¶å‰å½±ç‰‡çš„æ‰€æœ‰å‹¾é¸å—ï¼Ÿ")) return;
  const frames = framesData[getCurrentVideoName()];
  frames.forEach(f => { for (let i = 1; i <= 10; i++) f.labels[i] = false; });
  showFrame(currentFrame);
  saveState();
};

// å¾©åŸ
document.getElementById('restoreBtn').onclick = restoreState;

// å„²å­˜ç‹€æ…‹
function saveState() {
  localStorage.setItem('multiVideoState', JSON.stringify({framesData, videoList}));
}
function restoreState() {
  const saved = localStorage.getItem('multiVideoState');
  if (!saved) return alert("æ²’æœ‰å¯å¾©åŸçš„è³‡æ–™");
  const obj = JSON.parse(saved);
  framesData = obj.framesData;
  videoList = obj.videoList || [];
  selector.innerHTML = '';
  videoList.forEach((v, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = v.name;
    selector.appendChild(opt);
  });
  loadVideo(0);
  alert("å·²å¾©åŸå…ˆå‰æ¨™è¨»è³‡æ–™ï¼");
}

// Zoom + Pan
container.addEventListener('wheel', e => {
  e.preventDefault();
  const delta = e.deltaY > 0 ? 0.9 : 1.1;
  scale = Math.min(Math.max(scale * delta, 1), 5);
  updateTransform();
});
container.addEventListener('mousedown', e => {
  dragging = true;
  startX = e.clientX - posX;
  startY = e.clientY - posY;
  container.style.cursor = 'grabbing';
});
container.addEventListener('mouseup', () => { dragging = false; container.style.cursor = 'grab'; });
container.addEventListener('mousemove', e => {
  if (!dragging) return;
  posX = e.clientX - startX;
  posY = e.clientY - startY;
  updateTransform();
});
function updateTransform() {
  video.style.transform = `scale(${scale}) translate(${posX/scale}px, ${posY/scale}px)`;
}
function getCurrentVideoName() { return videoList[currentVideoIndex]?.name || "æœªå‘½åå½±ç‰‡"; }
</script>

</body>
</html>
